/*
Item
{
  "id":"ChwKGkNJZTltN1RvLV9BQ0ZhWV9yUVlkTmVNR2FB",
  "timestampUsec":"1622735398655288",
  "authorName":{
    "simpleText":"エルフの森のテシ"
  },
  "authorPhoto":{
    "thumbnails":[{
      "url":"https://yt4.ggpht.com/ytc/AAUvwnijaS-IXryHs3v9ySIGL_ffxO4eCqeQEyZudpW0=s32-c-k-c0x00ffffff-no-rj",
      "width":32,
      "height":32
    },
    {
      "url":"https://yt4.ggpht.com/ytc/AAUvwnijaS-IXryHs3v9ySIGL_ffxO4eCqeQEyZudpW0=s64-c-k-c0x00ffffff-no-rj",
      "width":64,
      "height":64
    }]
  },
  "purchaseAmountText":{
    "simpleText":"¥1,000"
  },
  "message":{
    "runs":[{
      "text":"すいませんが眠気限界なのでここらで失礼しますので先にスパチャ送っておきます。65万人おめでとうございますフライング"
    }
  ]},
  "headerBackgroundColor":4294947584,
  "headerTextColor":3741319168,
  "bodyBackgroundColor":4294953512,
  "bodyTextColor":3741319168,
  "authorExternalChannelId":"UCu6W6LF-_gPuDMUvUT65jng",
  "authorNameTextColor":2315255808,
  "contextMenuEndpoint":{
    "clickTrackingParams":"CAUQ7rsEIhMIoNzvuOj78AIVjSNgCh2iUwDV",
    "commandMetadata":{
      "webCommandMetadata":{
        "ignoreNavigation":true
      }
    },
    "liveChatItemContextMenuEndpoint":{
      "params":"Q2g0S0hBb2FRMGxsT1cwM1ZHOHRYMEZEUm1GWlgzSlJXV1JPWlUxSFlVRWFLU29uQ2hoVlEzWkpibHA0T1dnemFrTXlTbnB6U1hwdlQyVmlWMmNTQzJkaVIyZHZPVlpYZVhWM0lBSW9CRElhQ2hoVlEzVTJWelpNUmkxZloxQjFSRTFWZGxWVU5qVnFibWMlM0Q="
    }
  },
  "timestampColor":2147483648,
  "contextMenuAccessibility":{
    "accessibilityData":{
      "label":"Comment actions"
    }
  },
  "trackingParams":"CAUQ7rsEIhMIoNzvuOj78AIVjSNgCh2iUwDV"
}

{
  "liveChatTextMessageRenderer":{
    "message":{
      "runs":[{
        "emoji":{
          "emojiId":"UCFTLzh12_nrtzqBPsTCqenA/mP6GX7vWL8n0-gOgjIiwBA",
          "shortcuts":[":_AKIROSEWelcome:",":AKIROSEWelcome:",":_Welcome:",":Welcome:"],
          "searchTerms":["_AKIROSEWelcome","AKIROSEWelcome","_Welcome","Welcome"],
          "image":{
            "thumbnails":[
              {"url":"https://yt3.ggpht.com/jZ93yFKyNLIXltdKUOyGUV6TPJA-ThkOLA9BxHKWE-zfkeR7peyAn0ThWpsV3X72PYDp6kvsJA=w24-h24-c-k-nd","width":24,"height":24},
              {"url":"https://yt3.ggpht.com/jZ93yFKyNLIXltdKUOyGUV6TPJA-ThkOLA9BxHKWE-zfkeR7peyAn0ThWpsV3X72PYDp6kvsJA=w48-h48-c-k-nd","width":48,"height":48}
            ],
            "accessibility":{"accessibilityData":{"label":"AKIROSEWelcome"}}
          },
          "isCustomEmoji":true
        }
      }]
    },
    "authorName":{"simpleText":"Dmar 90"},
    "authorPhoto":{
      "thumbnails":[
        {"url":"https://yt4.ggpht.com/ytc/AAUvwniDJJf-YK4HPV5ye68mcEiGBPQJ1Ux4smJBX8Aq=s32-c-k-c0x00ffffff-no-rj","width":32,"height":32},
        {"url":"https://yt4.ggpht.com/ytc/AAUvwniDJJf-YK4HPV5ye68mcEiGBPQJ1Ux4smJBX8Aq=s64-c-k-c0x00ffffff-no-rj","width":64,"height":64}
      ]
    },
    "contextMenuEndpoint":{
      "commandMetadata":{
        "webCommandMetadata":{"ignoreNavigation":true}
      },
      "liveChatItemContextMenuEndpoint":{
        "params":"Q2tjS1JRb2FRMGxNTVRaeE5qQnBVRVZEUm1OVlRuSlJXV1F4ZGpCSmFFRVNKME5NTW1sMFgwOTVhVkJGUTBaV2JtOWpkMFZrYzNkWlNWQkJNVFl5TXpFMk9EQTVOamt5TlJvcEtpY0tHRlZEUmxSTWVtZ3hNbDl1Y25SNmNVSlFjMVJEY1dWdVFSSUxTSGhvU2tsNVYwdzVSMVVnQWlnRU1ob0tHRlZEVXpZMVMxOWhiVlJrTlRaTlFsbHBPRlZQYVVGNFp3JTNEJTNE"
      }
    },
    "id":"CkUKGkNJTDE2cTYwaVBFQ0ZjVU5yUVlkMXYwSWhBEidDTDJpdF9PeWlQRUNGVm5vY3dFZHN3WUlQQTE2MjMxNjgwOTY5MjU%3D",
    "timestampUsec":"1623168097368754",
    "authorBadges":[{
      "liveChatAuthorBadgeRenderer":{
        "customThumbnail":{
          "thumbnails":[
            {"url":"https://yt3.ggpht.com/B-sCF7klO0bH0U56SZXyVuJtJ6aEEayTp7wzetnF2DOUwnPVf5Pq9Gi1o8zmzf2CIdNfK3BGs8E=s16-c-k"},
            {"url":"https://yt3.ggpht.com/B-sCF7klO0bH0U56SZXyVuJtJ6aEEayTp7wzetnF2DOUwnPVf5Pq9Gi1o8zmzf2CIdNfK3BGs8E=s32-c-k"}
          ]
        },
        "tooltip":"Member (6 months)",
        "accessibility":{
          "accessibilityData":{
            "label":"Member (6 months)"
          }
        }
      }
    }],
    "authorExternalChannelId":"UCS65K_amTd56MBYi8UOiAxg",
    "contextMenuAccessibility":{
      "accessibilityData":{
        "label":"Comment actions"
      }
    }
  }
}

// NEW MEMBER
{
  "liveChatMembershipItemRenderer":{
    "id":"ChwKGkNQYWxpLXZyLV9BQ0ZTZ0hyUVlkNmtRSnFR",
    "timestampUsec":"1622736311406238",
    "authorExternalChannelId":"UCkngng9eT6TOajGoOIaCF6w",
    "headerSubtext":{
      "runs":[
        {"text":"Welcome to "},
        {"text":"フレアファン"},
        {"text":"!"}
      ]
    },
    "authorName":{"simpleText":"13EqualsB"},
    "authorPhoto":{
      "thumbnails":[
        {"url":"https://yt4.ggpht.com/ytc/AAUvwnj0d1mdD_dUQs8p50ZoKmewLMCN4MUNu1y3zAjw=s32-c-k-c0x00ffffff-no-rj","width":32,"height":32},
        {"url":"https://yt4.ggpht.com/ytc/AAUvwnj0d1mdD_dUQs8p50ZoKmewLMCN4MUNu1y3zAjw=s64-c-k-c0x00ffffff-no-rj","width":64,"height":64}
      ]
    },
    "authorBadges":[
      {"liveChatAuthorBadgeRenderer":{
        "customThumbnail":{
          "thumbnails":[
            {"url":"https://yt3.ggpht.com/ZJ1aBJMBh5LlzSAUMicgVE8g_bzhDCCuFoH44C8rdJmTck2HVPNtBstr81-tYmMjCq2oz6J4=s16-c-k"},
            {"url":"https://yt3.ggpht.com/ZJ1aBJMBh5LlzSAUMicgVE8g_bzhDCCuFoH44C8rdJmTck2HVPNtBstr81-tYmMjCq2oz6J4=s32-c-k"}
          ]
        },
        "tooltip":"New member",
        "accessibility":{
          "accessibilityData":{
            "label":"New member"
          }
        }
      }}
    ],
    "contextMenuEndpoint":{
      "commandMetadata":{
        "webCommandMetadata":{
          "ignoreNavigation":true
        }
      },
      "liveChatItemContextMenuEndpoint":{
        "params":"Q2g0S0hBb2FRMUJoYkdrdGRuSXRYMEZEUmxOblNISlJXV1EyYTFGS2NWRWFLU29uQ2hoVlEzWkpibHA0T1dnemFrTXlTbnB6U1hwdlQyVmlWMmNTQzJkaVIyZHZPVlpYZVhWM0lBSW9CRElhQ2hoVlEydHVaMjVuT1dWVU5sUlBZV3BIYjA5SllVTkdObmMlM0Q="
      }
    },
    "contextMenuAccessibility":{
      "accessibilityData":{
        "label":"Comment actions"
      }
    }
  }
}

// NORMAL
{"liveChatTextMessageRenderer":{"message":{"runs":[{"text":"クリケイしか知らんかった"}]},"authorName":{"simpleText":"alley cats1058"},"authorPhoto":{"thumbnails":[{"url":"https://yt4.ggpht.com/USPAT15fjnIHtjQ0HV7PoSfF0XMKkRUb_hZecQQiAgeFzd7vdPi6-k4m2oOkzm05VUQ-tnMH_3k=s32-c-k-c0x00ffffff-no-rj","width":32,"height":32},{"url":"https://yt4.ggpht.com/USPAT15fjnIHtjQ0HV7PoSfF0XMKkRUb_hZecQQiAgeFzd7vdPi6-k4m2oOkzm05VUQ-tnMH_3k=s64-c-k-c0x00ffffff-no-rj","width":64,"height":64}]},"contextMenuEndpoint":{"commandMetadata":{"webCommandMetadata":{"ignoreNavigation":true}},"liveChatItemContextMenuEndpoint":{"params":"Q2tjS1JRb2FRMGxJYmw4NGJuVXRYMEZEUm1SclRqVjNiMlJZWTNOQ1VuY1NKME5KWWpSMFpFeHpMVjlCUTBaUlZrMVpRVzlrTUUxclIxaDNNVFl5TWpjek56QTBORE00TkJvcEtpY0tHRlZEZGtsdVduZzVhRE5xUXpKS2VuTkplbTlQWldKWFp4SUxaMkpIWjI4NVZsZDVkWGNnQWlnRU1ob0tHRlZEWmtkaFREaGZlakJpYW5GWFUwODFUMDEyWkRGZlp3JTNEJTNE"}},"id":"CkUKGkNJSG5fOG51LV9BQ0Zka041d29kWGNzQlJ3EidDSWI0dGRMcy1fQUNGUVZNWUFvZDBNa0dYdzE2MjI3MzcwNDQzODQ%3D","timestampUsec":"1622737046991780","authorBadges":[{"liveChatAuthorBadgeRenderer":{"customThumbnail":{"thumbnails":[{"url":"https://yt3.ggpht.com/npSXKMFM9jDFjgE-oNhjS7tucrDmQXb7a6M-usEkyqipFCK5tRvL_du-dNotZGopjLCXMxXU3Q=s16-c-k"},{"url":"https://yt3.ggpht.com/npSXKMFM9jDFjgE-oNhjS7tucrDmQXb7a6M-usEkyqipFCK5tRvL_du-dNotZGopjLCXMxXU3Q=s32-c-k"}]},"tooltip":"Member (2 months)","accessibility":{"accessibilityData":{"label":"Member (2 months)"}}}}],"authorExternalChannelId":"UCfGaL8_z0bjqWSO5OMvd1_g","contextMenuAccessibility":{"accessibilityData":{"label":"Comment actions"}}}}
// NORMAL + MEMBER
{"liveChatTextMessageRenderer":{"message":{"runs":[{"text":"horamojenjen..."}]},"authorName":{"simpleText":"Uru"},"authorPhoto":{"thumbnails":[{"url":"https://yt4.ggpht.com/ytc/AAUvwniUAvY3bJonkM3cp2md9ZwKUuomNMiDgme8dgZv-96YB4aZmDzXeZilbXkr3uDD=s32-c-k-c0x00ffffff-no-rj","width":32,"height":32},{"url":"https://yt4.ggpht.com/ytc/AAUvwniUAvY3bJonkM3cp2md9ZwKUuomNMiDgme8dgZv-96YB4aZmDzXeZilbXkr3uDD=s64-c-k-c0x00ffffff-no-rj","width":64,"height":64}]},"contextMenuEndpoint":{"commandMetadata":{"webCommandMetadata":{"ignoreNavigation":true}},"liveChatItemContextMenuEndpoint":{"params":"Q2tjS1JRb2FRMUJmTW14amNuVXRYMEZEUm1WQlRuSlJXV1JMU1UxTlIzY1NKME5NZVd0d1lVeDFMVjlCUTBaU1dEQlhRVzlrTkRsWlRGbG5NVFl5TWpjek56QTBOalExTVJvcEtpY0tHRlZEZGtsdVduZzVhRE5xUXpKS2VuTkplbTlQWldKWFp4SUxaMkpIWjI4NVZsZDVkWGNnQWlnRU1ob0tHRlZEYjAxUk5WQm5ObmhUWkVoWk4xbG5kbWgzVVRSNFFRJTNEJTNE"}},"id":"CkUKGkNQXzJsY3J1LV9BQ0ZlQU5yUVlkS0lNTUd3EidDTHlrcGFMdS1fQUNGUlgwV0FvZDQ5WUxZZzE2MjI3MzcwNDY0NTE%3D","timestampUsec":"1622737047354287","authorExternalChannelId":"UCoMQ5Pg6xSdHY7YgvhwQ4xA","contextMenuAccessibility":{"accessibilityData":{"label":"Comment actions"}}}}

Action item
// NEW MEMBER
{"addLiveChatTickerItemAction":{"item":{"liveChatTickerSponsorItemRenderer":{"id":"ChwKGkNQYWxpLXZyLV9BQ0ZTZ0hyUVlkNmtRSnFR","detailText":{"runs":[{"text":"Member"}]},"detailTextColor":4294967295,"startBackgroundColor":4279213400,"endBackgroundColor":4278943811,"sponsorPhoto":{"thumbnails":[{"url":"https://yt4.ggpht.com/ytc/AAUvwnj0d1mdD_dUQs8p50ZoKmewLMCN4MUNu1y3zAjw=s32-c-k-c0x00ffffff-no-rj","width":32,"height":32},{"url":"https://yt4.ggpht.com/ytc/AAUvwnj0d1mdD_dUQs8p50ZoKmewLMCN4MUNu1y3zAjw=s64-c-k-c0x00ffffff-no-rj","width":64,"height":64}]},"durationSec":300,"showItemEndpoint":{"commandMetadata":{"webCommandMetadata":{"ignoreNavigation":true}},"showLiveChatItemEndpoint":{"renderer":{"liveChatMembershipItemRenderer":{"id":"ChwKGkNQYWxpLXZyLV9BQ0ZTZ0hyUVlkNmtRSnFR","timestampUsec":"1622736311406238","authorExternalChannelId":"UCkngng9eT6TOajGoOIaCF6w","headerSubtext":{"runs":[{"text":"Welcome to "},{"text":"フレアファン"},{"text":"!"}]},"authorName":{"simpleText":"13EqualsB"},"authorPhoto":{"thumbnails":[{"url":"https://yt4.ggpht.com/ytc/AAUvwnj0d1mdD_dUQs8p50ZoKmewLMCN4MUNu1y3zAjw=s32-c-k-c0x00ffffff-no-rj","width":32,"height":32},{"url":"https://yt4.ggpht.com/ytc/AAUvwnj0d1mdD_dUQs8p50ZoKmewLMCN4MUNu1y3zAjw=s64-c-k-c0x00ffffff-no-rj","width":64,"height":64}]},"authorBadges":[{"liveChatAuthorBadgeRenderer":{"customThumbnail":{"thumbnails":[{"url":"https://yt3.ggpht.com/ZJ1aBJMBh5LlzSAUMicgVE8g_bzhDCCuFoH44C8rdJmTck2HVPNtBstr81-tYmMjCq2oz6J4=s16-c-k"},{"url":"https://yt3.ggpht.com/ZJ1aBJMBh5LlzSAUMicgVE8g_bzhDCCuFoH44C8rdJmTck2HVPNtBstr81-tYmMjCq2oz6J4=s32-c-k"}]},"tooltip":"New member","accessibility":{"accessibilityData":{"label":"New member"}}}}],"contextMenuEndpoint":{"commandMetadata":{"webCommandMetadata":{"ignoreNavigation":true}},"liveChatItemContextMenuEndpoint":{"params":"Q2g0S0hBb2FRMUJoYkdrdGRuSXRYMEZEUmxOblNISlJXV1EyYTFGS2NWRWFLU29uQ2hoVlEzWkpibHA0T1dnemFrTXlTbnB6U1hwdlQyVmlWMmNTQzJkaVIyZHZPVlpYZVhWM0lBSW9CRElhQ2hoVlEydHVaMjVuT1dWVU5sUlBZV3BIYjA5SllVTkdObmMlM0Q="}},"contextMenuAccessibility":{"accessibilityData":{"label":"Comment actions"}}}}}},"authorExternalChannelId":"UCkngng9eT6TOajGoOIaCF6w","fullDurationSec":300}},"durationSec":"300"}}
// SUPER CHAT
{"clickTrackingParams":"CAEQl98BIhMI-J2Uh-z78AIVf9dMAh0kagVk","addLiveChatTickerItemAction":{"item":{"liveChatTickerPaidMessageItemRenderer":{"id":"ChwKGkNQYXB1X19yLV9BQ0ZlYzdyUVlkbzJvUGpn","amount":{"simpleText":"¥500"},"amountTextColor":4278190080,"startBackgroundColor":4280150454,"endBackgroundColor":4278239141,"authorPhoto":{"thumbnails":[{"url":"https://yt4.ggpht.com/ytc/AAUvwnj1rOw_UmTWa-M023m0i9lq6lx_4cgFvTRBb6Dz=s32-c-k-c0x00ffffff-no-rj","width":32,"height":32},{"url":"https://yt4.ggpht.com/ytc/AAUvwnj1rOw_UmTWa-M023m0i9lq6lx_4cgFvTRBb6Dz=s64-c-k-c0x00ffffff-no-rj","width":64,"height":64}],"accessibility":{"accessibilityData":{"label":"Pawel Szymczykowski"}}},"durationSec":120,"showItemEndpoint":{"clickTrackingParams":"CAIQsMgEIhMI-J2Uh-z78AIVf9dMAh0kagVk","commandMetadata":{"webCommandMetadata":{"ignoreNavigation":true}},"showLiveChatItemEndpoint":{"renderer":{"liveChatPaidMessageRenderer":{"id":"ChwKGkNQYXB1X19yLV9BQ0ZlYzdyUVlkbzJvUGpn","timestampUsec":"1622736368306182","authorName":{"simpleText":"Pawel Szymczykowski"},"authorPhoto":{"thumbnails":[{"url":"https://yt4.ggpht.com/ytc/AAUvwnj1rOw_UmTWa-M023m0i9lq6lx_4cgFvTRBb6Dz=s32-c-k-c0x00ffffff-no-rj","width":32,"height":32},{"url":"https://yt4.ggpht.com/ytc/AAUvwnj1rOw_UmTWa-M023m0i9lq6lx_4cgFvTRBb6Dz=s64-c-k-c0x00ffffff-no-rj","width":64,"height":64}]},"purchaseAmountText":{"simpleText":"¥500"},"message":{"runs":[{"text":"Only your railgun"}]},"headerBackgroundColor":4278239141,"headerTextColor":4278190080,"bodyBackgroundColor":4280150454,"bodyTextColor":4278190080,"authorExternalChannelId":"UCQf6i13evZ9tDp8uLvfqhUQ","authorNameTextColor":2315255808,"contextMenuEndpoint":{"clickTrackingParams":"CAQQ7rsEIhMI-J2Uh-z78AIVf9dMAh0kagVk","commandMetadata":{"webCommandMetadata":{"ignoreNavigation":true}},"liveChatItemContextMenuEndpoint":{"params":"Q2g0S0hBb2FRMUJoY0hWZlgzSXRYMEZEUm1Wak4zSlJXV1J2TW05UWFtY2FLU29uQ2hoVlEzWkpibHA0T1dnemFrTXlTbnB6U1hwdlQyVmlWMmNTQzJkaVIyZHZPVlpYZVhWM0lBSW9CRElhQ2hoVlExRm1ObWt4TTJWMldqbDBSSEE0ZFV4MlpuRm9WVkUlM0Q="}},"timestampColor":2147483648,"contextMenuAccessibility":{"accessibilityData":{"label":"Comment actions"}},"trackingParams":"CAQQ7rsEIhMI-J2Uh-z78AIVf9dMAh0kagVk"}},"trackingParams":"CAMQjtEGIhMI-J2Uh-z78AIVf9dMAh0kagVk"}},"authorExternalChannelId":"UCQf6i13evZ9tDp8uLvfqhUQ","fullDurationSec":120,"trackingParams":"CAIQsMgEIhMI-J2Uh-z78AIVf9dMAh0kagVk"}},"durationSec":"120"}}
*/

const axios = require('axios');
const parse = require('node-html-parser');
const express = require("express")
const cors = require('cors')
const bodyParser = require("body-parser")
const querystring = require('querystring');

var DeepLAPI = require("./DeepL.json");

const PORT = process.env.PORT || 31023
const app = express()
app.use(bodyParser.json( { limit: '20mb'} ))
app.use(bodyParser.urlencoded({ extended: true, limit: '20mb' }))
app.use(cors());

const head = {'user-agent': 'Mozilla5.0 (Windows NT 10.0; Win64; x64) AppleWebKit537.36 (KHTML, like Gecko) Chrome75.0.3770.142 Safari537.36'}    

const ReservedChannel = [
  'UCxvlgkpP5z98LsRudHN_Ucg', //  NEKOBOSHI MINTO
  'UCDqI2jOz0weumE8s7paEk6g', //  ROBOCO
  'UCp-5t9SrOQwXMU7iIjQfARg', //  OOKAMI MIO
  'UCp6993wxpyDPHUpavwDFqgg', //  TOKINO SORA
  'UCFTLzh12_nrtzqBPsTCqenA'  //  AKI ROSENTHAL
]

function KeySeeker(KeyName, JSONStr){
  Keyidx = JSONStr.indexOf(KeyName);
  if (Keyidx != -1){
    Keyidx += KeyName.length;
    return (JSONStr.substring(Keyidx, JSONStr.indexOf('"', Keyidx + KeyName.length)));
  } else {
    console.log(KeyName + " NOT FOUND");
    return undefined;
  }
}

async function StartYTCPoll(Key, ContTkn, VisDt, CVer, TrialCount, ProxySetting){
    //  START FETCHING LIVE CHAT
    const res = await axios.post("https://www.youtube.com/youtubei/v1/live_chat/get_live_chat?key=" + Key,
    {
      "context": {
        "client": {
          "visitorData": VisDt,
          "userAgent": head['user-agent'],
          "clientName": "WEB",
          "clientVersion": CVer,
        },
      },
      "continuation": ContTkn,
    },
    { headers : head}
  ).catch(e => e.response)

  if (!res){
    if (TrialCount == 3){
      console.log("CONNECTION POLLING ERROR");
    } else {
      await new Promise(r => setTimeout(r, 1000));
      StartYTCPoll(Key, ContTkn, VisDt, CVer, TrialCount+1);  
    }
    return;
  }

  if(res.status != 200){
    console.log("CONNECTION POST ERROR");
    return;
  }

  if (!res.data.continuationContents){
    console.log("LIVE STREAM FINISHED");
    return;
  }

  //  PARSE RESULT CONTINUATION TOKEN CHANGES BUT VISITOR TOKEN DOES NOT CHANGE
  ContTkn = KeySeeker('"continuation":"', JSON.stringify(res.data.continuationContents.liveChatContinuation.continuations));
  if (!ContTkn){
    console.log("CONNECTION NEW CONTINUATION TOKEN ERROR");
    return;
  }

  if (res.data.continuationContents.liveChatContinuation.actions){
    for (const actionItem of res.data.continuationContents.liveChatContinuation.actions) {
      if ("addChatItemAction" in actionItem) {
        const item = actionItem.addChatItemAction.item;
        if ("liveChatTextMessageRenderer" in item) {
          //------------------------------------------ NORMAL MESSAGE ------------------------------------------
          var MessageContent = [];
          var BadgeContent = [];

          if(item.liveChatTextMessageRenderer.message){
            MessageContent = item.liveChatTextMessageRenderer.message.runs.map(dt => {
              if ("text" in dt){
                return (dt.text);
              } else if ("emoji" in dt) {
                if (dt.emoji.image.thumbnails){
                  return (dt.emoji.image.thumbnails[dt.emoji.image.thumbnails.length - 1].url);
                }
              }
            });
          }

          if (item.liveChatTextMessageRenderer.authorBadges){
            item.liveChatTextMessageRenderer.authorBadges.map(dt => {
              var thumbnailurl = Object.keys(dt.liveChatAuthorBadgeRenderer);
              for(let i = 0; i < thumbnailurl.length; i++){
                if (thumbnailurl[i].toLowerCase().indexOf("thumbnail") != -1){
                  thumbnailurl = dt.liveChatAuthorBadgeRenderer[thumbnailurl[i]].thumbnails;
                  BadgeContent.push({
                    Thumbnail: thumbnailurl[thumbnailurl.length - 1].url
                  });
                  /*
                  BadgeContent.push({
                    Title: dt.liveChatAuthorBadgeRenderer.tooltip,
                    Thumbnail: thumbnailurl[thumbnailurl.length - 1].url
                  });
                  */
                  break;
                }
              }
            });
          }

          BroadcastMessage({
            author: item.liveChatTextMessageRenderer.authorName.simpleText,
            authorPhoto: item.liveChatTextMessageRenderer.authorPhoto.thumbnails[item.liveChatTextMessageRenderer.authorPhoto.thumbnails.length - 1].url,
            badgeContent: BadgeContent,
            content: MessageContent
          });;
        } else if ("liveChatPaidMessageRenderer" in item) {
          //------------------------------------------ SC MESSAGE ------------------------------------------
          var MessageContent = [];
          if (item.liveChatPaidMessageRenderer.message){
            MessageContent = item.liveChatPaidMessageRenderer.message.runs.map(dt => {
              if ("text" in dt){
                return (dt.text);
              } else if ("emoji" in dt) {
                if (dt.emoji.image.thumbnails){
                  return (dt.emoji.image.thumbnails[dt.emoji.image.thumbnails.length - 1].url);
                }
              }
            });
          }

          BroadcastMessage({
            author: item.liveChatPaidMessageRenderer.authorName.simpleText,
            authorPhoto: item.liveChatPaidMessageRenderer.authorPhoto.thumbnails[item.liveChatPaidMessageRenderer.authorPhoto.thumbnails.length - 1].url,
            type: "SC",
            SC: item.liveChatPaidMessageRenderer.purchaseAmountText.simpleText,
            content: MessageContent
          });
        } else if ("liveChatMembershipItemRenderer" in item) {
          //------------------------------------------ MEMBER MESSAGE ------------------------------------------
          var MessageContent = [];
          if (item.liveChatMembershipItemRenderer.headerSubtext){
            MessageContent = item.liveChatMembershipItemRenderer.headerSubtext.runs.map(dt => {
              if ("text" in dt){
                return (dt.text);
              } else if ("emoji" in dt) {
                if (dt.emoji.image.thumbnails){
                  return (dt.emoji.image.thumbnails[dt.emoji.image.thumbnails.length - 1].url);
                }
              }
            });
          }

          BroadcastMessage({
            author: item.liveChatMembershipItemRenderer.authorName.simpleText,
            authorPhoto: item.liveChatMembershipItemRenderer.authorPhoto.thumbnails[item.liveChatMembershipItemRenderer.authorPhoto.thumbnails.length - 1].url,
            type: "MEMBER",
            content: MessageContent
          });
        } else {
          //------------------------------------------ MISC MESSAGE ------------------------------------------
        }
      } else if ("addLiveChatTickerItemAction" in actionItem) {
      }      
    }
  }

  console.log("FETCHING AGAIN");
  await new Promise(r => setTimeout(r, 5000));
  StartYTCPoll(Key, ContTkn, VisDt, CVer, 0);
}
//=========================================  YTC SKIMMER  =========================================



//-----------------------------------------  SERVER HANDLER  -----------------------------------------
async function BroadcastMessage(Msg){
  let s = "";
  Msg.content.forEach(dt => {
    if (dt.indexOf("https://") == -1){
      s += dt + " ";
    }
  });

  //  SKIP IF THERE'S A TRANSLATION BRACKET
  if (s.match(/\[.*\w\w.*\]|\(.*\w\w.*\)/) != null){
    return;
  }

  //  CANCEL IF THERE'S NO MORE THAN 3 CONSECUTIVE LETTERS
  if (s.match(/\p{L}\p{L}\p{L}\p{L}+/u) == null){
    return;
  }

  //  REMOVE EMOJIS
  s = s.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g, '').trim();
  let s2 = s.replace(/\s/g, '');

  //  SKIP IF LESS THAN 3
  if (s2.length < 4){
    return;
  }
  
  //  CANCEL IF LESS THAN HALF IS JAPANESE CHARACTERS
  if (s2.replace(/[\u3000-\u303f\u3040-\u309f\u30a0-\u30ff\uff00-\uff9f\u4e00-\u9faf\u3400-\u4dbf]/g, '').length*4.0 < s2.length*3.0){
    return;
  }

  s = s.trim();

  //  REPLACE ALL THE REPEATING MORE THAN 3 TIMES
  s2 = s.match(/(.+)\1{3,}/ug)
  if (s2 != null){
    s2.forEach(e => {
      for (let dt = e[0], i = 0; dt.length != e.length; dt += e[++i]){
        if (e.replace(new RegExp(dt.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, '\\$&'), 'g'), '') == ""){
          switch (dt.length) {
            case 1:
              s = s.replace(e, dt + dt + dt);
              break;
            case 2:
              s = s.replace(e, dt + dt);
              break;
            default:
              s = s.replace(e, dt);
              break;
          }
          break;
        }
      }
    });
  }
  console.log(s);

  //  GET TRANSLATION
  /*
  const res = await axios.post("https://api-free.deepl.com/v2/translate",
  querystring.stringify({
    auth_key: DeepLAPI.APIkey,
    text: s,
    target_lang: 'JA',
    split_sentences: 0
  })
  ).catch(e => e.response)

  if (res.status != 200){
    console.log("ERROR DEEPLAPI");
  } else {
    console.log(s + "(" + res.data.translations[0].text + ")");
  }
  */
}

app.get('/Skimmer', async function (req, res) {
  if (!req.query.vidID)  {
    return res.status(400).send("NO VID ID");
  }

  var res2 = await axios.get("https://www.youtube.com/watch?v=" + req.query.vidID, {headers: head});

  let idx = res2.data.indexOf('<meta itemprop="channelId"');
  if (idx == -1) return;
  idx = res2.data.indexOf('content="', idx);
  if (idx == -1) return;
  idx += ('content="').length;
  let text = res2.data.substr(idx, res2.data.indexOf('">', idx) - idx);
  //if (!ReservedChannel.includes(text)) return res.status(400).send("NOT INCLUDED");

  if(res2.status != 200){
    console.log("CONNECTION GET PARAM ERROR");
    return;
  }

  var Key = KeySeeker('"INNERTUBE_API_KEY":"', res2.data);
  if (!Key){
    console.log("KEY ERROR");
    return;
  }

  var ContTkn = KeySeeker('"continuation":"', res2.data);
  if (!ContTkn){
    console.log("NOT LIVE");
    return;
  }

  var VisDt = KeySeeker('"visitorData":"', res2.data);
  if (!VisDt){
    console.log("VISITOR DATA ERROR");
    return;
  }

  var CVer = KeySeeker('"clientVersion":"', res2.data);
  if (!CVer){
    console.log("CLIENT VER ERROR");
    return;
  }

  StartYTCPoll(Key, ContTkn, VisDt, CVer, 0);
  return res.status(200).send("OK");
})

app.listen(PORT, async function () {
  console.log(`Server initialized on port ${PORT}`);
})